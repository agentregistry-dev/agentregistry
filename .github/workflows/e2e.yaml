name: E2E Tests

on:
  pull_request:
    branches: [main]
    paths-ignore:
      - '**/*.md'
  workflow_dispatch:

env:
  GO_VERSION: '1.25'
  BUILDX_BUILDER_NAME: arctl-e2e-builder

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: go.sum

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          name: ${{ env.BUILDX_BUILDER_NAME }}
          use: true
          driver-opts: network=host

      - name: Install Go tool dependencies
        run: go install tool

      - name: Run E2E tests
        env:
          DOCKER_BUILDER: "docker buildx"
          DOCKER_BUILD_ARGS: "--push --platform linux/amd64"
        run: make e2e

      - name: Dump cluster state on failure
        if: failure()
        run: |
          echo "=== Kind clusters ==="
          go tool kind get clusters 2>/dev/null || true
          echo ""
          echo "=== Pods ==="
          kubectl get pods -A --context kind-arctl-e2e 2>/dev/null || true
          echo ""
          echo "=== Pod describe ==="
          kubectl describe pods --context kind-arctl-e2e 2>/dev/null || true
          echo ""
          echo "=== Events ==="
          kubectl get events -A --sort-by='.lastTimestamp' --context kind-arctl-e2e 2>/dev/null | tail -50 || true
          echo ""
          echo "=== Kagent pods ==="
          kubectl get pods -n kagent --context kind-arctl-e2e 2>/dev/null || true
          echo ""
          echo "=== Kagent controller logs ==="
          kubectl logs deployment/kagent-controller -n kagent --context kind-arctl-e2e --tail=100 2>/dev/null || true
